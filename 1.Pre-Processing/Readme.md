# Pre-Processing (for model training)

**File:** `mask_gen.ipynb`
**Path:** `/shared/data/climateplus2025/CapeTown_Image_2023_Training_1024_Oct.28/mask_gen.ipynb`

This code prepares the dataset for model training

**Step1 : Crop tiles and create masked patches**

* Import `.GPKG` file (`final_annotations_PV_all_types_5K_cleaned.gpkg`)
* Convert the annotated polygons into pixel coordinates aligned with each corresponding GeoTIFF image, preparing them for image tiling and mask generation.
* Crop the raw `.tif` aerial imagery(12500*12500) into target patch sizes(e.g., 1024*1024)

```
CapeTown_Image_2023_Training_1024_Oct.28 (/shared/data/climateplus2025/CapeTown_Image_2023_Training_1024_Oct.28)
├── Images_original/  → Raw aerial imagery .tif files (12500x12500) 
├── tile_1024_5k  → All tiled 1024*1024 image patches
├── masks_1024_5k  → Corresponding segmentation masks for all patches
├── images_target_5k  → Filtered image patches that contain solar energy system objects
├── masks_target_5k  → Segmentation masks for the filtered image patches
├── final_annotations_PV_all_types_5K_cleaned.gpkg → Annotation polygons(Generated by `QGIS`)
```

**Step2 Data Split for model training**
* **Stratified sampling** is applied based on each tile’s label combination to preserve the distribution of multi-label tile types across the train/val/test split.

```
CapeTown_Image_2023_Training_1024_Oct.28 (/shared/data/climateplus2025/CapeTown_Image_2023_Training_1024_Oct.28)
├── ...(Same as above)
├── ...
├── output5k_stratified/ → Based on 5K annotations<br>
│   └── test/
│       ├── images/
│       └── masks/
│   └── train/
│       ├── images/
│       └── masks/
│   └── val/
│       ├── images/
│       └── masks/
```
# Pre-Processing (for prediction only)
**File:**`Image_tiling.ipynb` 
**Path:**`/shared/data/climateplus2025/CapeTown_Image_2023_3samples_poster_1024size_Nov20/Image_tiling.ipynb`

* This code crops the original `.tif` aerial imagery (12500 x 12500 pixels) into n x n pixels patches
* Tiling can be applied to a a file or the entire folder.
* For example, tile sizes such as 320 x 320 or **1024 x 1024** can be used


-----
* The following folders contain unseen, but **labeled** dataset used for strict evaluation. 

For **320 x 320** cropped images,
**Path:** `/shared/data/climateplus2025/CapeTown_Image_2023_3samples_poster`

For **1024 x 1024** coppred images, 
**Path:** `/shared/data/climateplus2025/CapeTown_Image_2023_3samples_poster_1024size_Nov20`

**Note**: The annotation (Ground Truth) `.gpkg` files for these images is located at:
`/shared/data/climateplus2025/Prediction_for_poster_3_images_July21/0.Image_files_selection/final_annotations_PV_all_types_balanced_3_cleaned.gpkg`

------
* The following folders contain the **raw entire** `.tif` aerial imagery, to automize download process, please refer to `Step 1. Download data` section in the `0.Data_Preparation`
```
/data/data/capetown_bc_2025/Data
├── CapeTown_Image_2018_original 
├── CapeTown_Image_2019_original
├── CapeTown_Image_2020_original
├── CapeTown_Image_2021_original
├── CapeTown_Image_2022_original
├── CapeTown_Image_2023_original
```
------
* This folders contain the cropped aerial imagery corresponding to the models
**Note:320, and 1024 are patch size**

/shared/data/climateplus2025/` or `/data/data/climateplus2025/
├── CapeTown_Image_2019_cropped_320
├── CapeTown_Image_2020_cropped_320
├── CapeTown_Image_2021_cropped_320
├── CapeTown_Image_2022_cropped_320
├── CapeTown_Image_2023_cropped_320
├── CapeTown_Image_2023_cropped_1024

-----
#### Appendix

* These are additional training datasets used previously in the YOLO pipeline(https://github.com/catherine-n/climateplus2025). 
* They are not part of the current pipeline but may be reused for additional Mask2Former training. All have one class and different resolutions from the Cape Town dataset (8 cm/pixel).

**Germany Dataset (15.5cm/pixels)**
* Path: `/home/il72/cape_town_year_of_installation/datasets/pv_germany`
* Reference: https://www.nature.com/articles/s41597-023-02539-8

**California Dataset (32cm/pixels)**
* Path: `/home/il72/cape_town_year_of_installation/datasets/pv_california`
* Reference: https://www.nature.com/articles/sdata2016106
